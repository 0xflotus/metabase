name: MRR & Churn
description: Builds tables needed for MRR and churn calculations
requires:
  OrderHistory:
      dimensions:
        - Income
        - CreationTimestamp
#        - User
provides:
  MRRStatistics:
       dimensions:
         - CreationTimestamp
         - ChurrnedMRR
         - MRRChurn
#         - AccountChurn
         - MRR
 #        - Accounts
  #       - ARPU
steps:
  Charges:
      source: OrderHistory
      description: prepare data
      limit: 10
  #    expressions:
  #      Month: [datetime-field, [dimension, CreationTimestamp], month]
  #       PrevMonth: ["+", [dimension, CreationTimestamp], [interval, -1, month]]
  NextMonth:
       description: dummy table for self-join
       source: Charges
  MRR:
      source: Charges
      description: calculate a bunch of statistics
      aggregation:
        MRR: [sum, [dimension, Income]]
#        Accounts: [count-distinct, [dimension, User]]
#        ARPU: [/, [dimension, MRR], [dimension , Accounts]]
      breakout: CreationTimestamp
  MRRStatistics:
      description: pull it all together
      source: Charges
      aggregation:
        ChurrnedMRR: [sum-where, [dimension, Income], [is-null, [dimension, NextMonth.CreationTimestamp]]]
        MRRChurn: [/, [dimension, ChurrnedMRR], [min, [dimension, MRR.MRR]]]
  #      AccountChurn: [count-when, [is-null, [dimension, NextMonth.CreationTimestamp]]]
      breakout:
        - CreationTimestamp
        - MRR.MRR
#        - MRR.Accounts
      join:
        - source: NextMonth
          strategy: left-join
# [=, [dimension, Charges.User], [dimension, NextMonth.User]],
          condition: [=, [dimension, Charges.CreationTimestamp], [dimension, NextMonth.CreationTimestamp]]
        - source: MRR
          strategy: inner-join
          condition: [=, [dimension, Charges.CreationTimestamp], [dimension, MRR.CreationTimestamp]]
